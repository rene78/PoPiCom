<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PopPics</title>
</head>

<body>
  <script>
    const demopics = {
      "batchcomplete": "",
      "continue": {
        "lecontinue": "20200608111159|295782671",
        "continue": "-||"
      },
      "query": {
        "logevents": [
          {
            "logid": 295818389,
            "ns": 6,
            "title": "File:Tropicana The Residence and W Hotel in Kuala Lumpur.jpeg",
            "pageid": 91077508,
            "logpage": 91077508,
            "timestamp": "2020-06-09T13:29:23Z"
          },
          {
            "logid": 295818079,
            "ns": 6,
            "title": "File:Skyscrapers of Kuala Lumpur, Malaysia (42721121372).jpg",
            "pageid": 91077208,
            "logpage": 91077208,
            "timestamp": "2020-06-09T13:17:29Z"
          },
          {
            "logid": 295782801,
            "ns": 6,
            "title": "File:Lamp Bear in June 2020.jpg",
            "pageid": 91044393,
            "logpage": 91044393,
            "timestamp": "2020-06-08T11:17:12Z"
          },
          {
            "logid": 295782674,
            "ns": 6,
            "title": "File:KLIA during CMCO due to Coronavirus pandemic in June 2020 04.jpg",
            "pageid": 91044273,
            "logpage": 91044273,
            "timestamp": "2020-06-08T11:12:03Z"
          },
          {
            "logid": 295782672,
            "ns": 6,
            "title": "File:KLIA during CMCO due to Coronavirus pandemic in June 2020 02.jpg",
            "pageid": 91044271,
            "logpage": 91044271,
            "timestamp": "2020-06-08T11:11:59Z"
          }
        ]
      }
    }

    function getPics() {
      let url = "https://commons.wikimedia.org/w/api.php?";

      const params = {
        action: "query",
        list: "logevents",
        letype: "upload",
        leprop: "title|timestamp|ids", //what type of data to return
        lelimit: "5", //number of pictures to return. Max is 500
        leuser: "Renek78", //user from whom to get picture data
        format: "json", //format of returned file
        origin: "*" //CORS
      };

      Object.keys(params).forEach(function (title) { url += "&" + title + "=" + params[title]; });
      console.log(url);

      fetch(url)
        .then(response => response.json())
        .then(response => { getUsageCount(response)/*console.log(response.query.logevents);*/ })
        .catch(error => { console.log(error); });

      // const response = await fetch(url);
      // return await response.json();

    }
    getPics();

    // async function asyncCall() {
    //   console.log('calling');
    //   const result = await getPics();
    //   // console.log(result);
    //   return result;
    //   // expected output: 'resolved'
    // }

    function getUsageCount(allPics) {
      let url = "https://www.mediawiki.org/w/api.php?";
      // let url = "https://www.mediawiki.org/w/api.php?action=query&prop=globalusage&gulimit=20&titles=File:Ferrari%20Roma%20in%20Basel.png";

      const params = {
        action: "query",
        prop: "globalusage",
        format: "json", //format of returned file
        gulimit: "20", //number of uses to return. Max is 500
        titles: getTitles(),
        origin: "*" //CORS
      };

      function getTitles() {
        return allPics.query.logevents.map(entry => entry.title).join("|");
      }

      Object.keys(params).forEach(function (title) { url += "&" + title + "=" + params[title]; });
      console.log(url);

      fetch(url)
        .then(response => response.json())
        .then(response => { console.log(response); })
        .catch(error => { console.log(error); });
    }
    // getUsageCount();
  </script>
</body>

</html>